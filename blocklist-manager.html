<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Block List Manager</title>

<style>
    body { font-family: Arial; margin: 20px; background:#f5f7fb; }
    h2 { margin-bottom: 10px; }
    .card {
        background:white; padding:15px; margin-bottom:20px;
        border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    input,button {
        padding:8px; font-size:14px; border-radius:5px;
    }
    input { width:100%; border:1px solid #bbb; }
    button { cursor:pointer; border:none; background:#2563eb; color:white; margin-top:8px; }
    button.red { background:#b91c1c; }
    .hidden { display:none !important; }
</style>

</head>
<body>

<h2>üîí AB2soft Block List Manager</h2>



<!-- TOKEN INPUT -->
<div class="card">
    <h3>Personal Access Token</h3>
    <input id="token" type="password" placeholder="Paste PAT">
    <button onclick="saveToken()">Save Token</button>
    <div id="tokmsg"></div>
</div>

<!-- ADD -->
<div class="card">
    <h3>Add Requester ID</h3>
    <input id="addId" placeholder="Enter new requester ID">
    <button onclick="addRequester()">Add</button>
    <div id="addmsg"></div>
</div>

<!-- REMOVE -->
<div class="card">
    <h3>Remove Requester ID</h3>
    <input id="removeId" placeholder="Enter requester ID to remove">
    <button class="red" onclick="removeRequester()">Remove</button>
    <div id="removemsg"></div>
</div>

<!-- HIDDEN BLOCK LIST & JSON -->
<div id="listBox" class="hidden"></div>
<pre id="jsonBox" class="hidden"></pre>

<script>
/* ------------------------
   EXACT TARGET INFORMATION
------------------------ */
const owner  = "Vinylgeorge";
const repo   = "400err";
const path   = "block_list.json";
const branch = "main";

let token = "";
let fileSha = "";
let blockList = [];

/* Save PAT */
function saveToken() {
    token = document.getElementById("token").value.trim();
    if (!token) {
        document.getElementById("tokmsg").innerHTML = "‚ùó Enter a valid token";
        return;
    }
    document.getElementById("tokmsg").innerHTML = "‚úîÔ∏è Token saved";
    loadFromGitHub();
}

/* Load block_list.json from GitHub */
async function loadFromGitHub() {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;

    const res = await fetch(url, {
        cache: "no-store",
        headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
        document.getElementById("tokmsg").innerHTML = "‚ùó Invalid token or no write access";
        return;
    }

    const data = await res.json();
    fileSha = data.sha;

    const decoded = atob(data.content);
    const json = JSON.parse(decoded);

    blockList = [...new Set(json.block_list)].sort();
}

/* Update file on GitHub */
async function updateGitHub() {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

    const newContent = { block_list: blockList };
    const encoded = btoa(JSON.stringify(newContent, null, 2));

    const body = {
        message: "Update block_list.json via AB2soft tool",
        content: encoded,
        sha: fileSha,
        branch: branch
    };

    const res = await fetch(url, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!res.ok) {
        alert("GitHub Error: " + JSON.stringify(data, null, 2));
        return;
    }

    fileSha = data.content.sha;
}

/* Add requester */
async function addRequester() {
    const id = document.getElementById("addId").value.trim().toUpperCase();
    if (!id) return;

    if (blockList.includes(id)) {
        document.getElementById("addmsg").innerHTML = "‚ùó Already exists";
        return;
    }

    blockList.push(id);
    blockList.sort();

    await updateGitHub();
    document.getElementById("addmsg").innerHTML = "‚úîÔ∏è Added";
}

/* Remove requester */
async function removeRequester() {
    const id = document.getElementById("removeId").value.trim().toUpperCase();
    if (!id) return;

    if (!blockList.includes(id)) {
        document.getElementById("removemsg").innerHTML = "‚ùó Not found";
        return;
    }

    blockList = blockList.filter(x => x !== id);

    await updateGitHub();
    document.getElementById("removemsg").innerHTML = "‚úîÔ∏è Removed";
}
</script>

</body>
</html>
