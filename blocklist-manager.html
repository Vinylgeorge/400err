<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Safe GitHub-Synced Block List Manager</title>

<style>
    body { font-family: Arial; margin: 20px; background:#f5f7fb; }
    h2 { margin-bottom: 10px; }
    .card {
        background:white; padding:15px; margin-bottom:20px;
        border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    input,button {
        padding:8px; font-size:14px; border-radius:5px;
    }
    input { width:100%; border:1px solid #bbb; }
    button { cursor:pointer; border:none; background:#2563eb; color:white; margin-top:8px; }
    button.red { background:#b91c1c; }
    .list-item {
        display:flex; justify-content:space-between; padding:5px 0;
        border-bottom:1px solid #eee; font-family: monospace;
    }
    pre {
        background:#111; color:#eee; padding:10px;
        border-radius:6px; font-size:12px; overflow-x:auto;
    }
</style>

</head>
<body>

<h2>üîí Safe GitHub-Synced Requester Block List Manager</h2>

<!-- TOKEN INPUT -->
<div class="card">
    <h3>GitHub Personal Access Token</h3>
    <p>‚≠ê Token is <b>NOT saved</b> and <b>never leaves your computer</b>.</p>
    <input id="token" type="password" placeholder="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">
    <button onclick="saveToken()">Save Token</button>
    <div id="tokmsg"></div>
</div>

<!-- ADD -->
<div class="card">
    <h3>Add Requester ID</h3>
    <input id="addId" placeholder="Enter new requester ID">
    <button onclick="addRequester()">Add</button>
    <div id="addmsg"></div>
</div>

<!-- REMOVE -->
<div class="card">
    <h3>Remove Requester ID</h3>
    <input id="removeId" placeholder="Enter requester ID to remove">
    <button class="red" onclick="removeRequester()">Remove</button>
    <div id="removemsg"></div>
</div>

<!-- LIST -->
<div class="card">
    <h3>Block List</h3>
    <div id="listBox"></div>
</div>

<!-- JSON -->
<div class="card">
    <h3>JSON Output</h3>
    <pre id="jsonBox"></pre>
</div>

<script>
/* ------------------------
   CONFIGURATION
------------------------ */
const owner  = "Vinylgeorge";
const repo   = "400err";
const path   = "block_list.json";
const branch = "main";

let token = "";
let fileSha = "";
let blockList = [];

/* ------------------------
   SAVE TOKEN (LOCAL ONLY)
------------------------ */
function saveToken() {
    token = document.getElementById("token").value.trim();
    if (!token) {
        document.getElementById("tokmsg").innerHTML = "‚ùó Enter a valid token";
        return;
    }
    document.getElementById("tokmsg").innerHTML = "‚úîÔ∏è Token saved (RAM only)";

    loadFromGitHub();
}

/* ------------------------
   LOAD EXISTING GITHUB JSON
------------------------ */
async function loadFromGitHub() {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
    const res = await fetch(url, {
        headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
        document.getElementById("tokmsg").innerHTML = "‚ùó Invalid token or no repo access";
        return;
    }

    const data = await res.json();
    fileSha = data.sha;

    const decoded = atob(data.content);
    const json = JSON.parse(decoded);

    blockList = [...new Set(json.block_list)].sort();

    render();
}

/* ------------------------
   PUSH UPDATED JSON TO GITHUB
------------------------ */
async function updateGitHub() {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

    const newContent = {
        block_list: blockList
    };

    const encoded = btoa(JSON.stringify(newContent, null, 2));

    const body = {
        message: "Update block_list.json via AB2soft HTML tool",
        content: encoded,
        sha: fileSha,
        branch: branch
    };

    const res = await fetch(url, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    const data = await res.json();
    fileSha = data.content.sha;
}

/* ------------------------
   ADD REQUESTER
------------------------ */
async function addRequester() {
    const id = document.getElementById("addId").value.trim().toUpperCase();
    if (!id) return;

    if (blockList.includes(id)) {
        document.getElementById("addmsg").innerHTML = "‚ùó Already exists";
        return;
    }

    blockList.push(id);
    blockList.sort();
    render();
    await updateGitHub();

    document.getElementById("addmsg").innerHTML = "‚úîÔ∏è Added & synced to GitHub";
}

/* ------------------------
   REMOVE REQUESTER
------------------------ */
async function removeRequester() {
    const id = document.getElementById("removeId").value.trim().toUpperCase();
    if (!id) return;

    if (!blockList.includes(id)) {
        document.getElementById("removemsg").innerHTML = "‚ùó Not in list";
        return;
    }

    blockList = blockList.filter(x => x !== id);
    render();
    await updateGitHub();

    document.getElementById("removemsg").innerHTML = "‚úîÔ∏è Removed & synced to GitHub";
}

/* ------------------------
   DIRECT REMOVE (UI button)
------------------------ */
async function removeDirect(id) {
    blockList = blockList.filter(x => x !== id);
    render();
    await updateGitHub();
}

/* ------------------------
   RENDER UI
------------------------ */
function render() {
    document.getElementById("jsonBox").textContent =
        JSON.stringify({ block_list: blockList }, null, 2);

    const box = document.getElementById("listBox");
    box.innerHTML = "";

    blockList.forEach(id => {
        const row = document.createElement("div");
        row.className = "list-item";
        row.innerHTML = `
            <span>${id}</span>
            <button class="red" onclick="removeDirect('${id}')">‚ùå</button>
        `;
        box.appendChild(row);
    });
}

</script>

</body>
</html>
